<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Questionário VARK - Parte 4</title>
    <link rel="stylesheet" href="/css/quest4_vark.css">
    <link rel="stylesheet" href="/css/header2.css">
    <link href="https://fonts.googleapis.com/css2?family=Fira+Sans:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
</head>
<body>
    <header>
      <a href="/aluno/a-minha-rotina"><img src="/images/voltar.svg" alt="Voltar"></a>
      <p>QUESTIONÁRIO VARK</p>
      <div>
        <p><%= user.NOME_USU || 'Aluno' %></p>
        <button class="user-icon" id="userIcon" aria-label="Abrir menu do usuário">
            <img src="/aluno/foto-perfil/<%= user.ID_USUARIO %>?v=<%= timestamp %>" alt="imagem do perfil" style="width: 48px; height: 48px; object-fit: cover; border-radius: 50%; border: 2px solid #ccc;" />
            <div class="user-config" id="userConfig">
                <ul>
                    <li><a href="/aluno/a-perfil">MENU</a></li>
                    <li><a href="/aluno/a-config">CONFIGURAÇÕES</a></li>
                    <li><a href="/aluno/logout">SAIR</a></li>
                </ul>
            </div>
        </button>
    </div>
    </header>

    <main class="container">
        <section class="instrucoes">
            <p>Escolha as respostas que melhor explicam a sua preferência. Nos casos em que apenas uma resposta não se encaixar suficientemente na sua percepção, por favor, escolha mais de uma. Deixe em branco qualquer questão que não se aplique.</p>
        </section>

        <form id="vark-form">
            <!-- Questão 13 -->
            <section class="quest">
                <h3>13 - Eu tenho um problema com o meu coração. Eu preferiria que o médico:</h3>
                <div class="options">
                    <label class="option">
                        <input type="radio" name="q13" value="c">
                        <span>Me mostrasse um diagrama sobre o que está errado.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q13" value="a">
                        <span>Descrevesse o que está errado.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q13" value="b">
                        <span>Me desse algo para ler para explicar o que está errado.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q13" value="d">
                        <span>Utilizasse um modelo de plástico para mostrar o que está errado.</span>
                    </label>
                </div>
            </section>

            <!-- Questão 14 -->
            <section class="quest">
                <h3>14 - Preciso encontrar o caminho para uma loja recomendada por um amigo. Eu:</h3>
                <div class="options">
                    <label class="option">
                        <input type="radio" name="q14" value="a">
                        <span>Pediria ao meu amigo as informações sobre como chegar.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q14" value="c">
                        <span>Usaria um mapa.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q14" value="d">
                        <span>Descobriria a localização da loja em relação a um local que conheço.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q14" value="b">
                        <span>Anotaria as informações sobre as ruas que preciso para lembrar.</span>
                    </label>
                </div>
            </section>

            <!-- Questão 15 -->
            <section class="quest">
                <h3>15 - Eu quero aprender como tirar fotografias melhores. Eu:</h3>
                <div class="options">
                    <label class="option">
                        <input type="radio" name="q15" value="d">
                        <span>Utilizaria exemplos de fotografias boas e ruins mostrando como melhorá-las.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q15" value="b">
                        <span>Utilizaria as instruções escritas sobre o que fazer.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q15" value="c">
                        <span>Utilizaria diagramas que show a câmera e o que cada parte faz.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q15" value="a">
                        <span>Faria perguntas e conversaria sobre a câmera e suas características.</span>
                    </label>
                </div>
            </section>

            <!-- Questão 16 -->
            <section class="quest">
                <h3>16 - Terminei uma competição ou prova e gostaria de ter um feedback. Gostaria que este feedback:</h3>
                <div class="options">
                    <label class="option">
                        <input type="radio" name="q16" value="a">
                        <span>Viesse de alguém que o discuta comigo.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q16" value="c">
                        <span>Tivesse utilização de gráficos mostrando o que eu alcancei.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q16" value="b">
                        <span>Tivesse a utilização de descrição escrita dos meus resultados.</span>
                    </label>
                    <label class="option">
                        <input type="radio" name="q16" value="d">
                        <span>Tivesse a utilização de exemplos do que eu fiz.</span>
                    </label>
                </div>
            </section>

            <div class="navegacao">
                <button type="button" class="botao-anterior" onclick="window.location.href='/aluno/quest3_vark'">ANTERIOR</button>
                <div class="indicador-progresso">
                    <span class="pagina-atual">4</span>
                    <span class="separador">/</span>
                    <span class="total-paginas">4</span>
                </div>
                <button type="button" class="botao-proximo" id="finalizar-vark">FINALIZAR</button>
            </div>
        </form>
        <script>
        document.getElementById('finalizar-vark').addEventListener('click', async function() {
            // Coleta respostas das 16 questões das 4 telas (localStorage)
            let respostas = [];
            let faltando = false;
            for (let i = 1; i <= 16; i++) {
                let valor = localStorage.getItem('vark_q' + i);
                // Conversão de letra para número
                let map = { a: 1, b: 2, c: 3, d: 4 };
                if (valor !== null && valor !== undefined && valor !== "") {
                    let respostaNum = map[valor] !== undefined ? map[valor] : parseInt(valor);
                    if (isNaN(respostaNum)) {
                        faltando = true;
                    } else {
                        respostas.push({ cod_questao: i, resposta: respostaNum });
                    }
                } else {
                    faltando = true;
                }
            }
            if (faltando || respostas.length !== 16) {
                alert('Responda todas as questões antes de finalizar.');
                return;
            }
            // Envia via AJAX
            try {
                const resp = await fetch('/aluno/vark/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ respostas })
                });
                const data = await resp.json();
                if (data.success && data.redirect) {
                    for (let i = 1; i <= 16; i++) localStorage.removeItem('vark_q' + i);
                    window.location.href = data.redirect;
                } else {
                    alert(data.message || 'Erro ao salvar respostas. Tente novamente.');
                }
            } catch (e) {
                alert('Erro ao enviar respostas. Tente novamente.');
            }
        });
        // Ao marcar uma alternativa, salva no localStorage
        for (let i = 13; i <= 16; i++) {
            let radios = document.getElementsByName('q' + i);
            for (let r = 0; r < radios.length; r++) {
                radios[r].addEventListener('change', function() {
                    localStorage.setItem('vark_q' + i, this.value);
                });
                // Preenche se já marcado
                let valor = localStorage.getItem('vark_q' + i);
                if (valor && radios[r].value == valor) radios[r].checked = true;
            }
        }
        </script>
    </main>

    <div class="container-progresso-geral">
        <div class="barra-progresso-grande">
            <div class="progresso-grande"></div>
        </div>
    </div>

    <footer>
        <div class="footer-text">
            <p> 2023 Questionário VARK. Todos os direitos reservados.</p>
            <p>Baseado no modelo VARK de Neil Fleming</p>
        </div>
    </footer>

    <script src="/js/icon-menu.js"></script>
</body>
</html>
